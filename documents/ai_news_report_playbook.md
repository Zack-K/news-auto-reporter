# 📰 AIニュースレポート自動生成プレイブック

## 🎯 目的
データサイエンス、データエンジニアリング、データ分析の学習者向けに、AIの最新ニュースを毎朝自動で収集し、  
**Notionにレポートを作成（カバー画像自動設定） → Slackに通知**することで、最新情報の共有を効率化します。

---

## ⏰ 実行スケジュール
- **毎日 08:00（日本標準時）** に定期実行（GitHub Actionsを使用）
- 実行対象スクリプト：`main.py`

**GitHub Actionsによる自動実行の詳細:**
*   **ワークフローファイル:** `.github/workflows/daily_report.yml`
*   **トリガー:**
    *   `schedule`: 毎日午前8時00分（日本標準時）に実行されるように設定されています（UTC 23:00）。
    *   `workflow_dispatch`: GitHub UIの「Actions」タブから手動でワークフローを実行できます。
*   **環境変数:** 必要なAPIキーや設定値は、GitHubリポジトリのSecretsとして安全に管理されています。ワークフローファイル内で`secrets.<SECRET_NAME>`として参照されます。
*   **Python環境:** `actions/setup-python`アクションでPython環境をセットアップし、`uv`を使用して依存関係をインストールします。
*   **失敗時の通知:** ワークフローの実行が失敗した場合、Slackに通知が送信されます。

---

## 🪜 実行ステップ

### ① AIニュースの収集
GoogleアラートのRSSフィードからAI関連の最新記事を全て収集します。

**抽出項目**
- 記事タイトル
- URL
- 公開日
- 概要（descriptionまたはsummary）
- 画像URL（OGP/Twitter Cardまたは記事本文から抽出）

各記事から、タイトル、URL、公開日、概要、画像URLを抽出します。外国語の記事については、日本語に翻訳し、要約を作成します。自動要約に加え、初学者向けのポイント（3行程度）を生成します。会話を促すコメントは、個別の記事ごとではなく、レポート全体のクロージングコメントとして生成されます。
**LLMによる記事選定と絞り込み後、記事タイトルからHTMLタグを除去し、クリーンなテキストとして後続処理に渡します。**

**パフォーマンスに関する考慮事項:**
*   **遅延処理:** 外部サイトへの負荷軽減のため、記事URLへのアクセス時に`time.sleep(0.5)`による遅延処理を導入しています。これにより、記事数が多い場合に収集時間が長くなる可能性があります。

---

### ② 記事の翻訳・カテゴリ分類・選定
収集したニュース記事を以下のカテゴリに分類します：

- データサイエンス  
- データエンジニアリング  
- データ分析  
- 人工知能  
- プログラミング  
- パフォーマンス最適化

**分類基準**
- 記事タイトル・概要のキーワード  
- 固有名詞（モデル名、技術名）  
- 記事発行元（例：OpenAI → 人工知能）

各カテゴリから、要件やテーマに合う記事をLLMで選定し、最大3記事に絞り込みます。

**LLMプロンプトのチューニング:**
*   **記事要約:** 初学者が読みやすいように、専門用語を避け、具体例や比喩を交えながら、200文字程度で詳しく要約するように調整。生成されるポイントは各50文字程度、クロージングコメントは100文字程度に制限されます。
*   **記事選定:** データサイエンス、データエンジニアリング、データ分析の学習者にとって最も有用で、会話のきっかけになりそうな記事を選定する基準を維持。
*   **クロージングコメント:** レポート全体のコミュニケーション促進を目的としたクロージングコメントを生成するように変更。

**パフォーマンスに関する考慮事項（並列化の検討）:**
*   LLMによる記事処理は、各記事に対して独立して行われるため、並列化の大きな効果が期待されます。
*   Pythonの`concurrent.futures.ThreadPoolExecutor`を利用して、複数のLLM API呼び出しを同時に実行することで、処理時間の短縮を目指します。
*   並列化の際には、Gemini APIのレート制限を考慮し、適切なワーカー数（並列度）を設定する必要があります。
*   エラーハンドリングとリトライメカニズムを組み込み、APIの一時的なエラーやレート制限超過に対応します。
*   注: 現在のコードベースでは、LLMによる記事処理の並列化は未実装です。

---

### ③ Notionデータベースへの書き込み
`notion-sdk-py` を使用して、指定のデータベースに新規ページを作成します。

**ページ構造**
- ページタイトル：  
  `AIニュースレポート - YYYY年MM月DD日` (HTMLタグは除去済み)
- 導入文：  
  `データサイエンス、データエンジニアリング、データ分析の学習者向けに、AIの最新ニュースを毎日お届けします。`
- 各カテゴリごとに見出し（`heading_2`）
- 各記事タイトル（URLリンク付き、`heading_3`） (HTMLタグは除去済み)
- 記事の要約（`paragraph`）
- 記事間には `divider` を挿入
- **カバー画像はUnsplashより取得した画像が自動設定されます。**

**処理フロー**
1. `fetch_latest_entry()` → RSS取得
2. `create_notion_page()` → Notionページ生成
3. Notion URLを返却

---

### ④ Slack通知メッセージの作成と送信
Slack Incoming Webhookを使い、指定チャンネルにレポート内容を送信します。

**メッセージ内容**
- レポートタイトル（`header`）
- 学習者を鼓舞する導入文（「知ってるだけで会話が弾む」内容を目指す）（`section`）
- 選定されたニュース記事（タイトル、URL、要約、初学者向けポイント） (記事タイトルはHTMLタグ除去済み)
- Dividerで区切り
- 最後に Notion レポートURLへのリンクを添付

**処理フロー**
1. Notion URLとニュースデータを受け取る  
2. `send_slack_message()` 関数で整形  
3. Webhook経由で送信

---

## ⚙️ 必要な環境変数

| 変数名                      | 説明                                | 例                                                |
|-----------------------------|-------------------------------------|--------------------------------------------------|
| `GOOGLE_API_KEY`            | Google Gemini APIキー               | `your_gemini_api_key`                            |
| `GOOGLE_ALERTS_RSS_URLS`    | GoogleアラートのRSSフィードURL      | `https://alerts.google.com/alerts/feeds/...`     |
| `NOTION_API_KEY`            | NotionのAPIキー                     | `secret_xxxxxxxxxxxxxxxxx`                       |
| `NOTION_DATABASE_ID`        | 書き込み先NotionデータベースのID    | `291axxxxxxxxxxxxx`                              |
| `SLACK_WEBHOOK_URL`         | Slack Incoming WebhookのURL         | `https://hooks.slack.com/services/...`          |
| `SLACK_CHANNEL`             | 通知するSlackチャンネル名           | `#ai-news`                                      |
| `REPORT_DATE`               | レポートの日付（実行時に自動設定）  | `2025-10-21` (例)                               |
| `UNSPLASH_ACCESS_KEY`       | Unsplash APIキー                    | `your_unsplash_access_key`                      |

---

## 📝 注意事項

- Notionの統合に対象データベースへの「**編集権限**」が付与されていることを確認してください。
- Slack Webhook URLには、対象チャンネルへの**投稿権限**が必要です。
- 翻訳・要約機能を追加する場合は、翻訳APIキーの管理にも注意してください。
- RSS元サイトのレート制限に留意し、アクセス間隔を調整してください。

---

## 🧰 使用スクリプト構成

```
project/
├── rss_single_fetch.py        # RSSフィードから記事取得
├── write_to_notion.py         # Notionへの書き込み
├── send_slack_message.py      # Slack通知
├── main.py                    # 全体実行パイプライン
├── llm_processor.py           # LLMによる記事処理（翻訳、要約、カテゴリ分類、選定、画像キーワード生成、クロージングコメント生成）
├── utils.py                   # 共通ユーティリティ（HTMLタグ除去など）
└── .env                       # 環境変数定義
```

---

## 🏃 実行例

```bash
# 1. 環境変数を設定
export NOTION_API_KEY="your_notion_key"
export NOTION_DATABASE_ID="your_db_id"
export SLACK_WEBHOOK_URL="your_webhook_url"
export SLACK_CHANNEL="#ai-news"

# 2. パイプラインを実行
python main.py
```

実行後、  
✅ Notionに新規レポートページが作成され、  
✅ Slackチャンネルにニュース要約とリンクが通知されます 🚀